<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Backend guide - The Fluence book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="kickstart.html"><strong aria-hidden="true">2.</strong> Quick start</a></li><li><a href="backend.html" class="active"><strong aria-hidden="true">3.</strong> Backend guide</a></li><li><a href="frontend.html"><strong aria-hidden="true">4.</strong> Frontend guide</a></li><li><a href="miner.html"><strong aria-hidden="true">5.</strong> Miner guide</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Fluence book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#introduction" id="introduction"><h3>Introduction</h3></a>
<p>This guide goes through the basics of application creation for the Fluence Network using simple Rust application as an example.</p>
<p>The Fluence ecosystem is designed to run Webassembly (Wasm) program in decentralized trustless environments. Generally it can be considered as several logical parts: a <code>client-side</code> (a frontend used for sending requests to Wasm program; developed by user), the <code>VM wrapper</code> (an intermediate layer that receives queries from <code>client side</code> and routes it to a <code>Wasm program</code>) and a <code>Wasm program</code> (also developed by user).</p>
<p>But an arbitrary Wasm code can't be run on Fluence - for example, it can use some imports of host-based functions that environment isn't provided for security reasons. And also each Wasm program has to follow some conventions to be able to interact with <code>VM wrapper</code>. These are described in details in <code>Wasm program conventions</code> section of this guide.</p>
<a class="header" href="#prerequisites" id="prerequisites"><h3>Prerequisites</h3></a>
<p>First of all, it needs to install Rust with Webassembly target. Currently, our SDK requires a nightly version of Rust since it uses some features that presently experimental. To install Rust, you can use the following commands:</p>
<pre><code class="language-bash"># installs Rust compiler and other tools to `~/.cargo/bin`
$ curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain nightly-2019-01-08

# updates `PATH` environment variable
$ source $HOME/.cargo/env

# installs target for Webassembly
$ rustup target add wasm32-unknown-unknown --toolchain nightly-2019-01-08
</code></pre>
<p>To check that everything is set up correctly you can use this simple command:</p>
<pre><code class="language-bash">$ echo &quot;fn main(){1;}&quot; &gt; test.rs; rustc --target=wasm32-unknown-unknown test.rs

$ ls -la test.wasm
-rwxr-xr-x  1 user  user   1.9M Feb  7 02:09 test.wasm*

</code></pre>
<p>It creates file with Rust code and then complies it to Webassembly. If it ends without errors and there is a <code>test.wasm</code> file in the same folder, set up is correct.</p>
<a class="header" href="#quick-start" id="quick-start"><h3>Quick start</h3></a>
<p>At first lets create a new empty Rust lib package f.e. by the following command:</p>
<pre><code class="language-bash">$ cargo new hello-user --lib --edition 2018
Created library `hello-user` package

$ cd hello-user
</code></pre>
<p>These commands create a stub for our project (more detailed info about package creating can be found <a href="https://doc.rust-lang.org/cargo/guide/creating-a-new-project.html">here</a>) and change current directory to it.</p>
<p>Let's show how to write a simple application by an example of a Rust program that receives a <code>user name</code> and returns &quot;Hello from Fluence to <code>user name</code>&quot;.</p>
<p>We'll write out code in src/lib.rs:</p>
<pre><code class="language-Rust">use fluence::sdk::*;

#[invocation_handler]
fn main(name: String) -&gt; String {
    format!(&quot;Hello from Fluence to {}&quot;, name)
}
</code></pre>
<p>And that's it! Pretty simple, isn't it?</p>
<p>Yeah, now we have a simple program that can be run on Fluence, lets compile it!</p>
<a class="header" href="#compilation-and-test-launch" id="compilation-and-test-launch"><h3>Compilation and test launch</h3></a>
<p><code>fluence</code> crate has to be specified in dependencies in <code>Cargo.toml</code> to compile this example. A minimal example <code>Cargo.toml</code> could look like this:</p>
<pre><code class="language-Toml">[package]
name = &quot;hello_user&quot;
version = &quot;0.1.1&quot;
edition = &quot;2018&quot;


[lib]
name = &quot;hello_user&quot;
path = &quot;src/lib.rs&quot;
crate-type = [&quot;cdylib&quot;]

[dependencies]
fluence = { version = &quot;0.0.8&quot;, features = [&quot;export_allocator&quot;]}
</code></pre>
<p>Currently, the last version of <code>fluence_sdk</code> is <code>0.0.8</code> but now it under construction and will change in future, stay tuned.</p>
<p>And finally to compile this example the following command could be used:</p>
<pre><code class="language-bash">$ cargo +nightly-2019-01-08 build --target wasm32-unknown-unknown --release
   Compiling proc-macro2 v0.4.27
   ...
    Finished release [optimized] target(s) in 21.97s
</code></pre>
<p>The worked example of <code>hello-user</code> program can be found <a href="https://github.com/fluencelabs/fluence/tree/master/vm/examples/hello-user">here</a>.</p>
<a class="header" href="#wasm-program-publishing" id="wasm-program-publishing"><h3>Wasm program publishing</h3></a>
<p>To publish resulted program <code>fluence/cli</code> can be used. This utility has a rich help that can be viewed by</p>
<pre><code class="language-bash">$ fluence help publish
...
USAGE:
    fluence publish [FLAGS] [OPTIONS] &lt;path&gt; &lt;contract_address&gt; &lt;account&gt;
    ...
</code></pre>
<p>By example for some setup the following command:</p>
<pre><code class="language-bash">$ fluence publish \
            --code_path        fluence/vm/examples/hello-user/target/wasm32-unknown-unknown/release/hello-user.wasm \            
            --account          0x4180fc65d613ba7e1a385181a219f1dbfe7bf11d \
            --cluster_size     4 \
            --secret_key       0xcb0799337df06a6c73881bab91304a68199a430ccd4bc378e37e51fd1b118133
</code></pre>
<p>publishes <code>hello-user.wasm</code> to contract identified by <code>0x9995882876ae612bfd829498ccd73dd962ec950a</code>, account <code>0x4180fc65d613ba7e1a385181a219f1dbfe7bf11d</code> to cluster of four nodes authenticated by secret key <code>0xcb0799337df06a6c73881bab91304a68199a430ccd4bc378e37e51fd1b118133</code>. To find more information about cli interface please look at <a href="https://github.com/fluencelabs/fluence/blob/master/docs/guides/miner.md">miner guide</a>.</p>
<a class="header" href="#wasm-program-conventions" id="wasm-program-conventions"><h3>Wasm program conventions</h3></a>
<p>Fluence uses so-called <code>verification game</code> technique to prove the correctness of computation results. Since that some limitations for Wasm program have been introduced:</p>
<ol>
<li>Wasm program can consist of several Wasm modules with different names, but only one of them (let's call it <code>main</code>) can be called from user-side. This master module HAS TO don't have the module name section. This requirement is based on the fact that according to the Wasm specification module name is optional, and there is no a possibility to add it to a generated Wasm binary by default <code>rust</code> compiler.</li>
<li>Each <code>main</code> module HAS TO have three export (regarding Wasm specification) functions with names <code>invoke</code>, <code>allocate</code> and <code>deallocate</code>.</li>
<li><code>invoke</code> will be used as the main module handler function. It means that all client-side requests are routed to it. The exactly signature of this function HAS TO be <code>(func (export &quot;invoke&quot;) (param $buffer i32) (param $size i32) (result i32))</code> in wast representation. It receives two i32 params that represent a pointer to supplied argument and its size. If <code>client-side</code> send an empty byte buffer <code>invoke</code> SHOULD be called with two nulls. This function has to return a pointer to result that has to have the next structure in memory: <code>| size (4 bytes; little endian) | result buffer (size bytes) |</code>. This convention is based on the fact that Wasm function can return value of i32, i64, f32, f64, i128 types.</li>
<li><code>allocate</code> function HAS TO have the next signature <code>(func (export &quot;allocate&quot;) (param $size i32) (result i32))</code> in wast representation. It HAS TO return a pointer as i32 to a module memory region long enough to hold <code>size</code> bytes.</li>
<li><code>deallocate</code> function HAS TO have the next signature <code>(func (export &quot;deallocate&quot;) (param $address i32) (param $size i32) (return))</code>. It is called by VM wrapper with a pointer to a memory region previously allocated through <code>allocate</code> function and its size. This function SHOULD free this memory region.</li>
</ol>
<p>A Wasm module usually is invoked by the following scheme:</p>
<ol>
<li>A <code>client-side</code> send a request to Wasm code as a byte array.</li>
<li><code>VM wrapper</code> call <code>allocate</code> function of <code>master</code> Wasm module with a size of the array.</li>
<li><code>VM wrapper</code> writes the array to the module memory.</li>
<li><code>VM wrapper</code> call <code>invoke</code> function from <code>master</code> module with the address returned from <code>allocate</code> function and the array size.</li>
<li><code>VM wrapper</code> synchronously waits of <code>invoke</code> result. After receiving a <code>pointer</code> from it, reads 4 bytes(that represents <code>size</code> of a byte array) and then reads <code>size</code> bytes from <code>pointer + 4</code> offset (<code>result</code>).</li>
<li><code>Result</code> as a byte array is sent to a client.</li>
</ol>
<a class="header" href="#best-practices" id="best-practices"><h3>Best practices</h3></a>
<ul>
<li>
<p>don't use panic! and methods that lead to it (expect, unwrap) in your code.</p>
</li>
<li>
<p>avoid using unsafe operations except these that already in Fluence SDK.</p>
</li>
<li>
<p>please pay attention to module memory usage - in many situations module can have public API that explicitly or indirectly consume module memory. So user can make a DoS attack to such programs.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="kickstart.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="frontend.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="kickstart.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="frontend.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
