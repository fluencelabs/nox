name: "publish-branch"

on:
  push:
    branches-ignore:
      - master
      - main

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  publish:
    name: "Publish branch"
    runs-on: builder
    defaults:
      run:
        shell: bash

    steps:
### Setup
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set branch name
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - run: |
          mkdir -p ./tmp/
          echo azaza > ./tmp/azaza

      - name: Save cache
        uses: leroy-merlin-br/action-s3-cache@v1
        id: S31
        with:
          action: put
          aws-access-key-id: ${{ secrets.AWS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1 # Or whatever region your bucket was created
          bucket: ${{ secrets.AWS_BUCKET }}
          s3-class: ONEZONE_IA # It's STANDARD by default. It can be either STANDARD,
          # REDUCED_REDUDANCY, ONEZONE_IA, INTELLIGENT_TIERING, GLACIER, DEEP_ARCHIVE or STANDARD_IA.
          key: ${{ github.workflow }}-${{ github.run_number }}
          artifacts: |
            ./tmp/azaza

      - run: echo ${{ steps.S31.outputs }}

      - uses: keithweaver/aws-s3-github-action@v1.0.0
        id: S32
        if: always()
        with:
          command: cp
          source: ./tmp/azaza
          destination: s3://${{ secrets.AWS_BUCKET }}/azaza
          aws_access_key_id: ${{ secrets.AWS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_region: eu-west-1

      - run: echo ${{ steps.S32.outputs }}

      - name: Upload file to bucket
        id: S33
        if: always()
        uses: zdurham/s3-upload-github-action@master
        with:
          args: --acl public-read
        env:
          FILE: ./tmp/azaza
          AWS_REGION: 'eu-west-1'
          S3_BUCKET: ${{ secrets.AWS_BUCKET }}
          S3_KEY: azaza
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - run: echo ${{ steps.S33.outputs }}

      - name: Upload Fluence binary
        if: always()
        uses: shallwefootball/s3-upload-action@v1.1.3
        id: S3azaza
        with:
          aws_key_id: ${{ secrets.AWS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
          aws_bucket: ${{ secrets.AWS_BUCKET }}
          source_dir: '/tmp/bugbugbug'

      - run: echo ${{steps.S3azaza.outputs.object_key}} ${{steps.S3azaza.outputs.object_locations}}
      - run: exit 1

      - uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly
          override: true

### Build
      - name: Set version in particle-node/Cargo.toml to ${{ env.BRANCH_NAME }}_${{ github.run_number }}
        run: |
          VERSION="0.0.${{ github.run_number }}"-"$(echo ${{ env.BRANCH_NAME }} | sed -e 's/[^a-zA-Z0-9-]/-/g')"
          sed -i 's/^version = ".*"/version = "'${VERSION}'"/' ./particle-node/Cargo.toml

      - name: Build particle-node
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release -p particle-node

### Upload
      - name: Calculate SHA256
        run: |
          BINARY="./target/release/particle-node"
          du -hs $BINARY
          echo $(sha256sum $BINARY)
          echo "SHA256=$(sha256sum $BINARY | awk '{ print $1 }')" >> $GITHUB_ENV

      - name: Upload Fluence binary
        uses: shallwefootball/s3-upload-action@v1.1.3
        id: S3
        with:
          aws_key_id: ${{ secrets.AWS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
          aws_bucket: ${{ secrets.AWS_BUCKET }}
          source_dir: './target/release/particle-node'

      - run: echo ${{steps.S3.outputs.object_key}} ${{steps.S3.outputs.object_locations}}

        # https://aws-bucket.s3.ap-northeast-2.amazonaws.com/${{steps.S3.outputs.object_key}}/index.html

### Update version in node-distro
      - name: Update version in node-distro
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: update_fluence
          repo: fluencelabs/node-distro
          ref: 'main'
          token: ${{ secrets.PERSONAL_TOKEN }}
          inputs: '{ 
            "container_tag": "${{ env.BRANCH_NAME }}",
            "version": "${{ env.BRANCH_NAME }}_${{ github.run_number }}",
            "url": "${{ steps.package-url.outputs.result }}",
            "sha256": "${{ env.SHA256 }}"
          }'


