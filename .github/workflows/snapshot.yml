# Compatibility workflow
name: "Publish snapshot"

on:
  workflow_call:
    inputs:
      ref:
        description: "git ref to checkout to"
        type: string
        default: "master"
      image-name:
        description: "Docker image name"
        type: string
        default: "docker.fluence.dev/rust-peer"
      cargo-dependencies:
        description: "Cargo dependencies map"
        type: string
        default: "null"
    outputs:
      rust-peer-image:
        description: "rust-peer snapshot image"
        value: ${{ jobs.container.outputs.rust-peer-image }}
      rust-peer-sha:
        description: "rust-peer sha256 hash"
        value: ${{ jobs.build.outputs.sha256 }}

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ inputs.ref }}

  container:
    needs: build
    uses: ./.github/workflows/container.yml
    with:
      image-name: "docker.fluence.dev/rust-peer"
      flavour: "minimal"
      rust-peer-sha: "${{ needs.build.outputs.sha256 }}"
